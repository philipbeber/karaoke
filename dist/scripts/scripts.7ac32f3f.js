"use strict";angular.module("kimeokeApp",["ngAnimate","ngAria","ngCookies","ngMessages","ngResource","ngRoute","ngSanitize","ngTouch","mgcrea.ngStrap"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl",controllerAs:"main"}).when("/about",{templateUrl:"views/about.html",controller:"AboutCtrl",controllerAs:"about"}).otherwise({redirectTo:"/"})}]),angular.module("kimeokeApp").service("CatalogService",["$http",function(a){function b(a,b){for(var c=0,e=0;e<b.length;e++)"\n"===b.charAt(e)&&(d(a,b.slice(c,e)),c=e+1);c<b.length&&d(a,b.slice(c,b.length))}function c(a){try{var b=a.match(/{([^:}]+)(:([^}]*))?}/);return{name:b[1],value:b[3]}}catch(c){throw new Error("Error getting metadata from: "+a+": "+c)}}function d(a,b){b=b.trim();var d=!1;if("{"===b.slice(0,1)){var f=c(b);if("t"===f.name||"title"===f.name?a.title=f.value:("st"===f.name||"subtitle"===f.name)&&(a.subtitle=f.value),"inline"!==f.name)return;b=b.slice("{inline}".length),d=!0}if("#"!==b.charAt(0)){for(var g=[],h=0,i=!1,j=0;j<b.length;j++)"["===b.charAt(j)?(e(b,h,j,i,g,d),i=!0,h=j+1):"]"===b.charAt(j)&&(e(b,h,j,i,g,d),i=!1,h=j+1);e(b,h,j,i,g,d),a.lines.push(g)}}function e(a,b,c,d,e,f){var g=a.slice(b,c);d&&(g+="   ");for(var h="",i=!1,j=0;j<g.length;++j)i||" "!==g.charAt(j)?(i=!0,h+=g.charAt(j)):h+="&nbsp;";for(g=h,h="",i=!1,j=g.length-1;j>=0;--j)i||" "!==g.charAt(j)?(i=!0,h=g.charAt(j)+h):h="&nbsp;"+h;g=h,f?e.push({chord:g,chordClass:d?"chord":"lyric"}):d?e.push({chord:g,chordClass:"chord"}):(0===e.length&&e.push({chord:"",chordClass:"chord"}),e[e.length-1].lyric=g)}this.getCatalog=function(){var b="/data/catalog.json";return a.get(b).then(function(a){return angular.forEach(a.data,function(a){angular.forEach(a.songs,function(b,c){for(var d=b.lastIndexOf("/"),e=b.indexOf(".",d),f=b.slice(d+1,e),g=f.length-1;g>0;g--)f[g].toUpperCase()===f[g]&&f[g-1!=="_"]?f=f.slice(0,g)+" "+f.slice(g):"_"===f[g]&&(f=f.slice(0,g)+" "+f.slice(g+1));a.songs[c]={title:f,url:b}})}),a.data})["catch"](function(a){throw console.error("Error downloading "+b+": "+a),a})},this.getSong=function(c){return a({method:"GET",url:c.url,transformResponse:function(a){var c={lines:[]};return b(c,a),c}}).then(function(a){return a.data})["catch"](function(a){throw console.error("Error downloading "+c.url+": "+a),a})}}]),angular.module("kimeokeApp").controller("ToplevelCtrl",["$scope","listChooserModal","$window","CatalogService",function(a,b,c,d){function e(){console.log("artist = "+h.artist+"; song = "+h.songs[l].title),d.getSong(h.songs[l]).then(function(b){a.selectedSong=b,console.log("getSong returned: "+b.title+"/"+b.subtitle)})}function f(a){var b=j;j=a,0===a&&(c.scroll(0,0),e()),1===b&&m.hide(),1===a&&m.show(),2===b&&n.hide(),2===a&&(h=i[k],l%=h.songs.length,n.setTitle(h.artist),n.setList(h.songs),n.setSelectedIndex(l),n.show())}function g(a){0===j&&c.scroll(0,c.scrollY+50*a),1===j&&(k=(k+i.length+a)%i.length,m.setSelectedIndex(k)),2===j&&(l=(l+h.songs.length+a)%h.songs.length,n.setSelectedIndex(l))}var h,i=[],j=0,k=0,l=0,m=b.createModal({nameProperty:"artist",scope:a}),n=b.createModal({nameProperty:"title",scope:a}),o=d.getCatalog();o.then(function(a){i=a,m.setTitle("Choose Artist"),m.setList(a),k=Math.floor(Math.random()*a.length),m.setSelectedIndex(k),h=i[k],l=Math.floor(Math.random()*h.songs.length),e()}),a.keyPress=function(b){var c=b.which;a.keyPressed=c,o.then(function(){var a=String.fromCharCode(c).toUpperCase();"Z"===a?f((j+2)%3):"X"===a?f((j+1)%3):"N"===a?g(-1):"M"===a&&g(1)})}}]),angular.module("kimeokeApp").service("listChooserModal",["$modal",function(a){this.createModal=function(b){var c=b.scope.$new(),d=a({scope:c,templateUrl:"views/templates/choose-from-list-modal.html",show:!1});c.title=b.title,c.list=b.list,c.nameProperty=b.nameProperty;var e=0;return{show:function(){angular.forEach(c.list,function(a,b){a.isSelected=b===e}),d.$promise.then(d.show())},hide:function(){d.$promise.then(d.hide())},setTitle:function(a){c.title=a},setList:function(a){c.list=a},setSelectedIndex:function(a){c.list[e]&&(c.list[e].isSelected=!1),e=a,c.list[e].isSelected=!0}}}}]),angular.module("kimeokeApp").directive("scrollIf",function(){var a=function(a){for(a=a.parentElement;a;){if(a.scrollHeight!==a.clientHeight)return a;a=a.parentElement}return null};return{restrict:"A",link:function(b,c,d){b.$watch(d.scrollIf,function(b){if(b){var e=a(c[0]),f=parseInt(d.scrollMarginTop)||0,g=parseInt(d.scrollMarginBottom)||0,h=c[0].offsetTop,i=c[0].clientHeight;h-f<e.scrollTop?e.scrollTop=h-f:h+i+g>e.scrollTop+e.clientHeight&&(e.scrollTop=h+i+g-e.clientHeight)}})}}}),angular.module("kimeokeApp").run(["$templateCache",function(a){a.put("views/templates/choose-from-list-modal.html",'<div class="modal" tabindex="-1" role="dialog"> <div class="modal-dialog"> <div class="modal-content"> <div class="modal-header"> <h4 class="modal-title">{{ title }}</h4> </div> <div class="modal-body choose-body"> <p ng-repeat="item in list" class="choose-list-row" ng-class="{ \'selected-row\': item.isSelected}" scroll-if="item.isSelected">{{item[nameProperty]}}</p> </div> </div> </div> </div>')}]);